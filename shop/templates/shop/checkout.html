{% extends 'shop/basic.html' %}
{% block title %}Checkout - SuperBazer {% endblock %}
{% block checkoutactive %}active{% endblock checkoutactive %}
{% block css %}
.homePage{
color: yellow;
text-decoration: none;
}
.chkpg{
margin: 0 318px;
position: absolute;
top: 68px;
}
.total{
position: relative;
left: 788px;
}
.del{
position: relative;
left: 770px;
}
.breadcrumb{
background-color: #D3D3D3;
}
.totpri{
position: relative;
top: -13px;
}
.fotr{
position: relative;
bottom: -15px;
}
{% endblock %}
{% block body %}
<div class="container">
    <div class="col my-4">
        <h2>Step 1 - SuperBazer Express Checkout - Review Your Cart items</h2>
        <div>
            <ul class="list-group" id='items'>
            </ul>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mt-3">
                    <li class="breadcrumb-item active" aria-current="page">
                        <span id="delivery"></span>
                    </li>
                </ol>
            </nav>
            <nav aria-label="breadcrumb ">
                <ol class="breadcrumb mt-3 totpri">
                    <li class="breadcrumb-item active" aria-current="page">
                        <span id="totalPrice"></span>
                    </li>
                </ol>
            </nav>
        </div>
    </div>
    <div class="col my-4">
        <h2>Step 2 - Enter Address & Other Details</h2>
        <form id="checkoutForm" method="post" action="/shop/checkout/">
            {% csrf_token %}
            <input type="hidden" name="itemsJson" id="itemsJson">
            <input type="hidden" name="amount" id="amount">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="name">Name</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="Name" Required>
                </div>
                <div class="form-group col-md-6">
                    <label for="inputEmail4">Email</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="Email" Required>
                </div>
            </div>
            <div class="form-group">
                <label for="inputAddress">Address</label>
                <input type="text" class="form-control" id="address1" name="address1" placeholder="1234 Main St" Required>
            </div>
            <div class="form-group">
                <label for="inputAddress2">Address Line 2</label>
                <input type="text" class="form-control" id="address2" name="address2" placeholder="Apartment, studio, or floor">
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="inputCity">City</label>
                    <input type="text" class="form-control" id="city" name="city">
                </div>
                <div class="form-group col-md-4">
                    <label for="inputState">State</label>
                    <input type="text" class="form-control" id="state" name="state" placeholder="Enter State">
                </div>
            </div>
            <div class="form-group col-md-2">
                <label for="inputZip">Zip</label>
                <input type="text" class="form-control" id="zip_code" name="zip_code">
            </div>
            <div class="form-group">
                <label for="inputZip">Phone Number</label>
                <input type="tel" class="form-control" id="phone" name="phone">
            </div>
            <button type="submit" class="btn btn-primary">Place Order</button>
        </form>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    let cart = {};

    {% if is_buynow %}
        cart = {
            "{{ prod.o.product.id}}":{
                name: "{{ prod.o.product.product_name }}",
                qty: "{{ prod.o.quantity }}",
                price: "{{ prod.o.product.price }}",
            }
        };
    {% else %}
        if (localStorage.getItem("cart") !== null) {
            try {
                cart = JSON.parse(localStorage.getItem("cart"));
                if (Object.keys(cart).length === 0) {
                    const myStr = `<p>Your Cart is Empty, Please Add Some Items</p>`;
                    document.getElementById("items").innerHTML = myStr;
                    return;
                }
            } catch (error) {
                console.error("Cart parsing error: ", error);
                cart = {};
                const myStr = `<p>Your Cart is Empty, Please Add Some Items</p>`;
                document.getElementById("items").innerHTML = myStr;
                return;
            }
        };
    {% endif %}

    // Auantiy and Number multiply-
    let total_price = 0;
    let deliveryCharge = 0;
    for (let item in cart) {
        let item_data = cart[item];
        let qty = parseInt(item_data.qty) || 0;

        let rawPrice = item_data.price;

        let itemPrice = typeof rawPrice === 'number' ? rawPrice : parseInt(rawPrice);

        if (isNaN(itemPrice)) {
            itemPrice = 0;
        }

        if (isNaN(qty)) {
            qty = 0;
        }

        total_price += qty * itemPrice;
    }

    // Add delivery charge-
    if (total_price <= 499) {
        deliveryCharge = 40;
        document.getElementById("delivery").innerHTML = `<b> Delivery Charge: <span class="del">₹<span>${deliveryCharge}</span></b>`
    } else {
        deliveryCharge = 0;
        document.getElementById("delivery").innerHTML = `<b> Delivery Charge: <span class="total">₹<span>0</span></b>`
    }

    // Final total-
    let final_price = total_price + deliveryCharge;

    document.getElementById("totalPrice").innerHTML = `<strong>Total Price:<span class="text-danger"> <span class="total">₹${final_price}</span></span></strong>`;

    // Set clean price in hidden input-
    document.getElementById("amount").value = final_price;


    // Update the hidden input on form submission-
    const checkoutForm = document.getElementById("checkoutForm");
    console.log("checkout form: ", checkoutForm)
    checkoutForm.addEventListener("submit", function() {
        const itemsJson = document.getElementById("itemsJson");
        if (itemsJson) {
            itemsJson.value = JSON.stringify(cart);
            console.log("itemsJson: ", (itemsJson), itemsJson.value)
        };
    });

    // Django template block (still server-side logic)
    {% if thank %}
    const thankmessage = `<p>Thanks for ordering with us. Your order id is {{ id }}. Use it to track your order using our order tracker</p>`;
    document.querySelector(".container").innerHTML = thankmessage + `<button class="btn btn-primary"><a href="/shop/" class='homePage'>Home Page</a></button>`;
    localStorage.clear();
    {% endif %}


    // Show cart items in the list-
    for (let id in cart) {
        let name = cart[id].name || "Unnamed Product"; //use the key as name
        let qty = cart[id].qty || 0;
        let myStr = `<li class="list-group-item d-flex justify-content-between align-items-center"> ${name}  <span class="badge badge-primary badge-pill" style="background-color:rgb(102, 119, 175);">${qty}</span></li>`;

        console.log(`Item: ${name}, Quantity: ${qty}`);
        document.getElementById("items").insertAdjacentHTML("beforeend", myStr);
    }

    // Display total items and show message if cart is empty
    updateCartDisplay(cart);

    function updateCartDisplay(cart) {
        let totalItems = 0;

        for (let item in cart) {
            totalItems += cart[item].qty;
        }

        const cartCounter = document.querySelector('#cart');
        if (cartCounter) {
            cartCounter.innerHTML = totalItems
        }

        if (totalItems === 0) {
            const container = document.querySelector(".container");
            if (container) {
                container.innerHTML = `<p class="my-3">No items in your cart. Please orader again.</p><button class="btn btn-primary chkpg"><a class="homePage" href="/shop/">Go To Home</a></button>`;
            }
        }
    }

    // On click, send cart data to server and then redirect
    document.querySelectorAll('.save-to-checkout').forEach(button => {
        button.addEventListener("click", function() {
            const cart_data = localStorage.getItem("cart");

            fetch("/shop/cart/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRF(),
                    },
                    body: JSON.stringify({ cart_data: cart_data }),
                })
                .then(() => {
                    window.location.href = "/shop/cart/";
                });

            function getCSRF() {
                return document.querySelector('[name=csrfmiddlewaretoken]').value;
            }
        })
    });
});
// Back to cart page-
function sendCartToCartPage() {
    const cart_data = localStorage.getItem("cart");

    fetch("/shop/cart/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify({ cart_data })
        })
        .then(response => response.json())
        .then(data => {
            window.location.href = "/shop/cart/"; // go to cart page
        })
        .catch(error => {
            console.error("Error sending cart to backend:", error);
        });
}

function getCSRFToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    //if (csrfInput) return csrfInput.content;
    return csrfInput ? csrfInput.content : '';
}
</script>
{% endblock %}